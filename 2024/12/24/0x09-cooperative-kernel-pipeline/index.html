<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>0x09 CUTLASS SM90 Cooperative Kernel Pipeline - CUTLASS 学习笔记</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#0d1117"><meta name="application-name" content="CUTLASS 学习笔记"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#0d1117"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="CUTLASS 学习笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This article explains CUTLASS SM90 Cooperative Kernel Pipeline mechanisms including Mainloop Pipeline, Epilogue Load&amp;#x2F;Store Pipeline, TileScheduler Pipeline, and LoadWarpOrderBarrier."><meta property="og:type" content="blog"><meta property="og:title" content="0x09 CUTLASS SM90 Cooperative Kernel Pipeline"><meta property="og:url" content="https://drxuqian.github.io/2024/12/24/0x09-cooperative-kernel-pipeline/"><meta property="og:site_name" content="CUTLASS 学习笔记"><meta property="og:description" content="This article explains CUTLASS SM90 Cooperative Kernel Pipeline mechanisms including Mainloop Pipeline, Epilogue Load&amp;#x2F;Store Pipeline, TileScheduler Pipeline, and LoadWarpOrderBarrier."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://drxuqian.github.io/img/og_image.png"><meta property="article:published_time" content="2024-12-23T16:00:00.000Z"><meta property="article:modified_time" content="2025-12-25T12:35:39.662Z"><meta property="article:author" content="DrXuQian"><meta property="article:tag" content="CUTLASS"><meta property="article:tag" content="SM90"><meta property="article:tag" content="Pipeline"><meta property="article:tag" content="mbarrier"><meta property="article:tag" content="Warp Specialization"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://drxuqian.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://drxuqian.github.io/2024/12/24/0x09-cooperative-kernel-pipeline/"},"headline":"0x09 CUTLASS SM90 Cooperative Kernel Pipeline","image":["https://drxuqian.github.io/img/og_image.png"],"datePublished":"2024-12-23T16:00:00.000Z","dateModified":"2025-12-25T12:35:39.662Z","author":{"@type":"Person","name":"DrXuQian"},"publisher":{"@type":"Organization","name":"CUTLASS 学习笔记","logo":{"@type":"ImageObject","url":"https://drxuqian.github.io/img/logo.svg"}},"description":"This article explains CUTLASS SM90 Cooperative Kernel Pipeline mechanisms including Mainloop Pipeline, Epilogue Load&#x2F;Store Pipeline, TileScheduler Pipeline, and LoadWarpOrderBarrier."}</script><link rel="canonical" href="https://drxuqian.github.io/2024/12/24/0x09-cooperative-kernel-pipeline/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 8.1.1"><link rel="stylesheet" href="/css/custom.css"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="CUTLASS 学习笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/DrXuQian"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-23T16:00:00.000Z" title="12/24/2024, 12:00:00 AM">2024-12-24</time>发表</span><span class="level-item"><time dateTime="2025-12-25T12:35:39.662Z" title="12/25/2025, 8:35:39 PM">2025-12-25</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/CUTLASS/">CUTLASS</a></span><span class="level-item">16 分钟读完 (大约2465个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">0x09 CUTLASS SM90 Cooperative Kernel Pipeline</h1><div class="content"><p>This article explains CUTLASS SM90 Cooperative Kernel Pipeline mechanisms including Mainloop Pipeline, Epilogue Load&#x2F;Store Pipeline, TileScheduler Pipeline, and LoadWarpOrderBarrier.</p>
<span id="more"></span>

<blockquote>
<p><strong>核心要点速览</strong></p>
<ol>
<li><strong>Warp 分工</strong>：Producer WarpGroup 分为 Mainloop&#x2F;Epilogue&#x2F;Scheduler&#x2F;Aux 四个角色</li>
<li><strong>Mainloop Pipeline</strong>：<code>PipelineTmaAsync</code>，Producer TMA 加载，Consumer MMA 计算</li>
<li><strong>Epilogue Load&#x2F;Store Pipeline</strong>：独立的加载和存储同步</li>
<li><strong>LoadWarpOrderBarrier</strong>：确保 Mainloop 先于 Epilogue 执行</li>
<li><strong>无 cluster_sync</strong>：使用 <code>cluster_arrive_relaxed</code> + 延迟 <code>cluster_wait</code></li>
</ol>
<p><strong>前置知识</strong>：<a href="/2024/12/23/pipeline-barrier-ptx-mapping/">Pipeline 与 mbarrier 深度解析</a>、<a href="/2024/12/24/tma-descriptor-deep-dive/">TMA Descriptor 深度解析</a></p>
</blockquote>
<h2 id="1-Warp-Specialization-架构"><a href="#1-Warp-Specialization-架构" class="headerlink" title="1. Warp Specialization 架构"></a>1. Warp Specialization 架构</h2><h3 id="1-1-线程组织"><a href="#1-1-线程组织" class="headerlink" title="1.1 线程组织"></a>1.1 线程组织</h3><p>Cooperative Kernel 使用 <strong>Warp Specialization</strong> 技术，将线程分为不同角色：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread Block (384 threads = 12 warps = 3 warp groups)</span><br><span class="line">+-- WarpGroup 0: Producer (128 threads = 4 warps)</span><br><span class="line">|   +-- Warp 0: Mainloop Producer (TMA Load A/B)</span><br><span class="line">|   +-- Warp 1: Scheduler Producer (CLC Query)</span><br><span class="line">|   +-- Warp 2: Epilogue Producer (TMA Load C)</span><br><span class="line">|   +-- Warp 3: MainloopAux Producer (auxiliary load)</span><br><span class="line">|</span><br><span class="line">+-- WarpGroup 1: Consumer0 (128 threads = 4 warps)</span><br><span class="line">|   +-- Execute MMA compute + Epilogue Store</span><br><span class="line">|</span><br><span class="line">+-- WarpGroup 2: Consumer1 (128 threads = 4 warps)</span><br><span class="line">    +-- Cooperate with Consumer0 on same tile</span><br></pre></td></tr></table></figure>

<h3 id="1-2-角色定义"><a href="#1-2-角色定义" class="headerlink" title="1.2 角色定义"></a>1.2 角色定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:366-376</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">WarpGroupRole</span> &#123;</span><br><span class="line">  Producer = <span class="number">0</span>,</span><br><span class="line">  Consumer0 = <span class="number">1</span>,</span><br><span class="line">  Consumer1 = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">ProducerWarpRole</span> &#123;</span><br><span class="line">  Mainloop = <span class="number">0</span>,     <span class="comment">// Warp 0: TMA Load A/B</span></span><br><span class="line">  Warp1 = <span class="number">1</span>,        <span class="comment">// Warp 1: Scheduler (CLC query)</span></span><br><span class="line">  Epilogue = <span class="number">2</span>,     <span class="comment">// Warp 2: TMA Load C</span></span><br><span class="line">  MainloopAux = <span class="number">3</span>   <span class="comment">// Warp 3: 辅助加载（可选）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-寄存器动态分配"><a href="#1-3-寄存器动态分配" class="headerlink" title="1.3 寄存器动态分配"></a>1.3 寄存器动态分配</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Producer: 低寄存器需求</span></span><br><span class="line">cutlass::arch::<span class="built_in">warpgroup_reg_dealloc</span>&lt;LoadRegisterRequirement&gt;();  <span class="comment">// 24-40 regs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer: 高寄存器需求（累加器）</span></span><br><span class="line">cutlass::arch::<span class="built_in">warpgroup_reg_alloc</span>&lt;MmaRegisterRequirement&gt;();     <span class="comment">// 232-240 regs</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-Pipeline-类型总览"><a href="#2-Pipeline-类型总览" class="headerlink" title="2. Pipeline 类型总览"></a>2. Pipeline 类型总览</h2><p>Cooperative Kernel 中使用了 <strong>5 种 Pipeline</strong>：</p>
<table>
<thead>
<tr>
<th>Pipeline</th>
<th>类型</th>
<th>Producer</th>
<th>Consumer</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Mainloop Pipeline</strong></td>
<td><code>PipelineTmaAsync</code></td>
<td>Mainloop Warp</td>
<td>Consumer0&#x2F;1</td>
<td>A&#x2F;B tile 加载</td>
</tr>
<tr>
<td><strong>Epilogue Load Pipeline</strong></td>
<td><code>PipelineTransactionAsync</code></td>
<td>Epilogue Warp</td>
<td>Consumer0&#x2F;1</td>
<td>C 矩阵加载</td>
</tr>
<tr>
<td><strong>Epilogue Store Pipeline</strong></td>
<td><code>PipelineTmaStore</code></td>
<td>Consumer0&#x2F;1</td>
<td>TMA Unit</td>
<td>D 矩阵写回</td>
</tr>
<tr>
<td><strong>Scheduler Pipeline</strong></td>
<td><code>PipelineAsync</code></td>
<td>Scheduler Warp</td>
<td>All Warps</td>
<td>Tile 调度</td>
</tr>
<tr>
<td><strong>LoadWarpOrderBarrier</strong></td>
<td><code>OrderedSequenceBarrier</code></td>
<td>Mainloop Warp</td>
<td>Epilogue Warp</td>
<td>加载顺序</td>
</tr>
</tbody></table>
<h3 id="2-1-Pipeline-存储结构"><a href="#2-1-Pipeline-存储结构" class="headerlink" title="2.1 Pipeline 存储结构"></a>2.1 Pipeline 存储结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:148-157</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SharedStorage</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">PipelineStorage</span> : cute::aligned_struct&lt;<span class="number">16</span>, _1&gt; &#123;</span><br><span class="line">    MainloopPipelineStorage mainloop;      <span class="comment">// Mainloop barriers</span></span><br><span class="line">    EpiLoadPipelineStorage epi_load;       <span class="comment">// Epilogue load barriers</span></span><br><span class="line">    <span class="keyword">typename</span> LoadWarpOrderBarrier::SharedStorage load_order;  <span class="comment">// 顺序控制</span></span><br><span class="line">  &#125; pipelines;</span><br><span class="line"></span><br><span class="line">  TileSchedulerStorage scheduler;          <span class="comment">// Scheduler barriers</span></span><br><span class="line">  TensorStorage tensors;                   <span class="comment">// SMEM 数据缓冲区</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-Mainloop-Pipeline"><a href="#3-Mainloop-Pipeline" class="headerlink" title="3. Mainloop Pipeline"></a>3. Mainloop Pipeline</h2><h3 id="3-1-初始化"><a href="#3-1-初始化" class="headerlink" title="3.1 初始化"></a>3.1 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:444-458</span></span><br><span class="line"><span class="keyword">using</span> MainloopPipeline = <span class="keyword">typename</span> CollectiveMainloop::MainloopPipeline;</span><br><span class="line"><span class="keyword">typename</span> MainloopPipeline::Params mainloop_pipeline_params;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Producer: Mainloop Warp 或 MainloopAux Warp</span></span><br><span class="line"><span class="keyword">if</span> (warp_group_role == WarpGroupRole::Producer &amp;&amp;</span><br><span class="line">    (producer_warp_role == ProducerWarpRole::Mainloop ||</span><br><span class="line">     producer_warp_role == ProducerWarpRole::MainloopAux)) &#123;</span><br><span class="line">  mainloop_pipeline_params.role = MainloopPipeline::ThreadCategory::Producer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer: Consumer0 和 Consumer1</span></span><br><span class="line"><span class="keyword">if</span> (warp_group_role == WarpGroupRole::Consumer0 ||</span><br><span class="line">    warp_group_role == WarpGroupRole::Consumer1) &#123;</span><br><span class="line">  mainloop_pipeline_params.role = MainloopPipeline::ThreadCategory::Consumer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mainloop_pipeline_params.is_leader = warp_group_thread_idx == <span class="number">0</span>;</span><br><span class="line">mainloop_pipeline_params.num_consumers = NumMMAThreads;         <span class="comment">// 256</span></span><br><span class="line">mainloop_pipeline_params.num_producers = NumProducerThreads;    <span class="comment">// 32 或 64</span></span><br><span class="line">mainloop_pipeline_params.transaction_bytes = params.mainloop.tma_transaction_bytes;</span><br><span class="line"></span><br><span class="line"><span class="function">MainloopPipeline <span class="title">mainloop_pipeline</span><span class="params">(shared_storage.pipelines.mainloop,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   mainloop_pipeline_params, ClusterShape&#123;&#125;)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Producer-端（Mainloop-Warp）"><a href="#3-2-Producer-端（Mainloop-Warp）" class="headerlink" title="3.2 Producer 端（Mainloop Warp）"></a>3.2 Producer 端（Mainloop Warp）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:585-650</span></span><br><span class="line"><span class="keyword">if</span> (producer_warp_role == ProducerWarpRole::Mainloop) &#123;</span><br><span class="line">  <span class="keyword">while</span> (work_tile_info.<span class="built_in">is_valid</span>()) &#123;</span><br><span class="line">    <span class="comment">// 调用 CollectiveMainloop::load()</span></span><br><span class="line">    collective_mainloop.<span class="built_in">load</span>(</span><br><span class="line">      params.mainloop,</span><br><span class="line">      mainloop_pipeline,           <span class="comment">// Pipeline 接口</span></span><br><span class="line">      mainloop_pipe_producer_state, <span class="comment">// 当前 stage</span></span><br><span class="line">      load_inputs,                 <span class="comment">// A/B tensors</span></span><br><span class="line">      blk_coord,</span><br><span class="line">      k_tile_iter, work_k_tile_count,</span><br><span class="line">      lane_idx,</span><br><span class="line">      block_rank_in_cluster,</span><br><span class="line">      shared_storage.tensors.mainloop</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    mainloop_pipe_producer_state.<span class="built_in">advance</span>(work_k_tile_count);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知 Epilogue Warp 可以开始</span></span><br><span class="line">    <span class="keyword">if</span> (do_load_order_arrive) &#123;</span><br><span class="line">      load_order_barrier.<span class="built_in">arrive</span>();</span><br><span class="line">      do_load_order_arrive = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取下一个 tile</span></span><br><span class="line">    work_tile_info = scheduler.<span class="built_in">fetch_next_work</span>(...);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知所有 Consumer 结束</span></span><br><span class="line">  collective_mainloop.<span class="built_in">load_tail</span>(mainloop_pipeline, mainloop_pipe_producer_state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Consumer-端（CollectiveMma-mma）"><a href="#3-3-Consumer-端（CollectiveMma-mma）" class="headerlink" title="3.3 Consumer 端（CollectiveMma::mma）"></a>3.3 Consumer 端（CollectiveMma::mma）</h3><p>Consumer 在 <code>CollectiveMainloop::mma()</code> 中使用 pipeline：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_mma_tma_gmma_ss_warpspecialized.hpp:470-577</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mma</span><span class="params">(MainloopPipeline pipeline, PipelineState smem_pipe_read,</span></span></span><br><span class="line"><span class="params"><span class="function">         Tensor&amp; accum, <span class="type">int</span> k_tile_count, ...)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  PipelineState smem_pipe_release = smem_pipe_read;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prologue: 预取前几个 tile</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; prologue_mma_count; ++k) &#123;</span><br><span class="line">    <span class="keyword">auto</span> barrier_token = pipeline.<span class="built_in">consumer_try_wait</span>(smem_pipe_read);</span><br><span class="line">    pipeline.<span class="built_in">consumer_wait</span>(smem_pipe_read, barrier_token);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 GMMA</span></span><br><span class="line">    cute::<span class="built_in">gemm</span>(tiled_mma, tCrA[read_stage], tCrB[read_stage], accum);</span><br><span class="line">    ++smem_pipe_read;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Main loop: 边计算边释放</span></span><br><span class="line">  <span class="keyword">for</span> (; k_tile_count &gt; <span class="number">0</span>; --k_tile_count) &#123;</span><br><span class="line">    <span class="keyword">auto</span> barrier_token = pipeline.<span class="built_in">consumer_try_wait</span>(smem_pipe_read);</span><br><span class="line">    pipeline.<span class="built_in">consumer_wait</span>(smem_pipe_read, barrier_token);</span><br><span class="line"></span><br><span class="line">    cute::<span class="built_in">gemm</span>(tiled_mma, tCrA[read_stage], tCrB[read_stage], accum);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">warpgroup_wait</span>&lt;K_PIPE_MMAS&gt;();  <span class="comment">// 等待前几个 MMA 完成</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放已计算完的 buffer</span></span><br><span class="line">    pipeline.<span class="built_in">consumer_release</span>(smem_pipe_release);</span><br><span class="line"></span><br><span class="line">    ++smem_pipe_read;</span><br><span class="line">    ++smem_pipe_release;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mma_tail: 释放剩余 buffer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mma_tail</span><span class="params">(MainloopPipeline pipeline, PipelineState smem_pipe_release, <span class="type">int</span> k_tile_count)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">warpgroup_wait</span>&lt;<span class="number">0</span>&gt;();  <span class="comment">// 等待所有 MMA 完成</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> count = <span class="number">0</span>; count &lt; prologue_mma_count; ++count) &#123;</span><br><span class="line">    pipeline.<span class="built_in">consumer_release</span>(smem_pipe_release);</span><br><span class="line">    ++smem_pipe_release;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-同步流程图"><a href="#3-4-同步流程图" class="headerlink" title="3.4 同步流程图"></a>3.4 同步流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant ML as Mainloop Warp</span><br><span class="line">    participant MP as MainloopPipeline</span><br><span class="line">    participant C0 as Consumer0</span><br><span class="line">    participant C1 as Consumer1</span><br><span class="line"></span><br><span class="line">    Note over ML,C1: Stage 0</span><br><span class="line"></span><br><span class="line">    ML-&gt;&gt;MP: producer_acquire (wait EmptyBarrier)</span><br><span class="line">    ML-&gt;&gt;MP: TMA Load A/B + expect_tx</span><br><span class="line">    ML-&gt;&gt;MP: producer_commit</span><br><span class="line"></span><br><span class="line">    par Consumer0 and Consumer1</span><br><span class="line">        C0-&gt;&gt;MP: consumer_wait (FullBarrier)</span><br><span class="line">        C1-&gt;&gt;MP: consumer_wait (FullBarrier)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    Note over C0,C1: GMMA 计算</span><br><span class="line"></span><br><span class="line">    par Consumer Release</span><br><span class="line">        C0-&gt;&gt;MP: consumer_release (EmptyBarrier)</span><br><span class="line">        C1-&gt;&gt;MP: consumer_release (EmptyBarrier)</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    ML-&gt;&gt;MP: 可以加载下一个 stage</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-Epilogue-Load-Pipeline"><a href="#4-Epilogue-Load-Pipeline" class="headerlink" title="4. Epilogue Load Pipeline"></a>4. Epilogue Load Pipeline</h2><h3 id="4-1-特点"><a href="#4-1-特点" class="headerlink" title="4.1 特点"></a>4.1 特点</h3><ul>
<li><strong>类型</strong>：<code>PipelineTransactionAsync</code>（与 Mainloop 相同）</li>
<li><strong>Producer</strong>：Epilogue Warp（Warp 2）</li>
<li><strong>Consumer</strong>：Consumer0 和 Consumer1</li>
<li><strong>用途</strong>：加载 C 矩阵用于 beta<em>C + alpha</em>A*B 融合</li>
</ul>
<h3 id="4-2-初始化"><a href="#4-2-初始化" class="headerlink" title="4.2 初始化"></a>4.2 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:460-475</span></span><br><span class="line"><span class="keyword">using</span> EpiLoadPipeline = <span class="keyword">typename</span> CollectiveEpilogue::LoadPipeline;</span><br><span class="line"><span class="keyword">typename</span> EpiLoadPipeline::Params epi_load_pipeline_params;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (warp_group_role == WarpGroupRole::Producer &amp;&amp;</span><br><span class="line">    producer_warp_role == ProducerWarpRole::Epilogue) &#123;</span><br><span class="line">  epi_load_pipeline_params.role = EpiLoadPipeline::ThreadCategory::Producer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (warp_group_role == WarpGroupRole::Consumer0 ||</span><br><span class="line">    warp_group_role == WarpGroupRole::Consumer1) &#123;</span><br><span class="line">  epi_load_pipeline_params.role = EpiLoadPipeline::ThreadCategory::Consumer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">epi_load_pipeline_params.dst_blockid = cute::<span class="built_in">block_rank_in_cluster</span>();</span><br><span class="line">epi_load_pipeline_params.producer_arv_count = NumEpilogueLoadThreads;  <span class="comment">// 32</span></span><br><span class="line">epi_load_pipeline_params.consumer_arv_count = NumMMAThreads;           <span class="comment">// 256</span></span><br><span class="line">epi_load_pipeline_params.transaction_bytes = params.epilogue.tma_transaction_bytes;</span><br><span class="line"></span><br><span class="line"><span class="function">EpiLoadPipeline <span class="title">epi_load_pipeline</span><span class="params">(shared_storage.pipelines.epi_load, epi_load_pipeline_params)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-Epilogue-Producer"><a href="#4-3-Epilogue-Producer" class="headerlink" title="4.3 Epilogue Producer"></a>4.3 Epilogue Producer</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:700-750</span></span><br><span class="line"><span class="keyword">if</span> (producer_warp_role == ProducerWarpRole::Epilogue &amp;&amp; is_epi_load_needed) &#123;</span><br><span class="line">  <span class="comment">// 等待 Mainloop 先开始</span></span><br><span class="line">  <span class="keyword">if</span> (work_tile_info.<span class="built_in">is_valid</span>()) &#123;</span><br><span class="line">    load_order_barrier.<span class="built_in">wait</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (work_tile_info.<span class="built_in">is_valid</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (TileScheduler::<span class="built_in">compute_epilogue</span>(work_tile_info, params.scheduler)) &#123;</span><br><span class="line">      epi_load_pipe_producer_state = collective_epilogue.<span class="built_in">load</span>(</span><br><span class="line">        epi_load_pipeline,</span><br><span class="line">        epi_load_pipe_producer_state,</span><br><span class="line">        problem_shape_MNKL,</span><br><span class="line">        blk_coord,</span><br><span class="line">        ...</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    work_tile_info = scheduler.<span class="built_in">fetch_next_work</span>(...);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  collective_epilogue.<span class="built_in">load_tail</span>(epi_load_pipeline, epi_load_pipe_producer_state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-Epilogue-Store-Pipeline"><a href="#5-Epilogue-Store-Pipeline" class="headerlink" title="5. Epilogue Store Pipeline"></a>5. Epilogue Store Pipeline</h2><h3 id="5-1-特点"><a href="#5-1-特点" class="headerlink" title="5.1 特点"></a>5.1 特点</h3><ul>
<li><strong>类型</strong>：<code>PipelineTmaStore</code></li>
<li><strong>无 mbarrier</strong>：使用 TMA scoreboarding 机制</li>
<li><strong>同步方式</strong>：<code>tma_store_arrive()</code> + <code>tma_store_wait&lt;N&gt;()</code></li>
</ul>
<h3 id="5-2-初始化"><a href="#5-2-初始化" class="headerlink" title="5.2 初始化"></a>5.2 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:477-481</span></span><br><span class="line"><span class="keyword">using</span> EpiStorePipeline = <span class="keyword">typename</span> CollectiveEpilogue::StorePipeline;</span><br><span class="line"><span class="keyword">typename</span> EpiStorePipeline::Params epi_store_pipeline_params;</span><br><span class="line">epi_store_pipeline_params.always_wait = <span class="literal">true</span>;  <span class="comment">// 始终等待</span></span><br><span class="line"><span class="function">EpiStorePipeline <span class="title">epi_store_pipeline</span><span class="params">(epi_store_pipeline_params)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-使用（Consumer-端）"><a href="#5-3-使用（Consumer-端）" class="headerlink" title="5.3 使用（Consumer 端）"></a>5.3 使用（Consumer 端）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:810-830</span></span><br><span class="line"><span class="keyword">if</span> (TileScheduler::<span class="built_in">compute_epilogue</span>(work_tile_info, params.scheduler)) &#123;</span><br><span class="line">  <span class="keyword">auto</span> [epi_load_pipe_consumer_state_next, epi_store_pipe_producer_state_next] =</span><br><span class="line">  collective_epilogue.<span class="built_in">store</span>(</span><br><span class="line">    epi_load_pipeline,</span><br><span class="line">    epi_load_pipe_consumer_state,</span><br><span class="line">    epi_store_pipeline,              <span class="comment">// Store pipeline</span></span><br><span class="line">    epi_store_pipe_producer_state,</span><br><span class="line">    problem_shape_MNKL,</span><br><span class="line">    blk_shape,</span><br><span class="line">    blk_coord,</span><br><span class="line">    accumulators,</span><br><span class="line">    ...</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  epi_load_pipe_consumer_state = epi_load_pipe_consumer_state_next;</span><br><span class="line">  epi_store_pipe_producer_state = epi_store_pipe_producer_state_next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结束时</span></span><br><span class="line">collective_epilogue.<span class="built_in">store_tail</span>(</span><br><span class="line">  epi_load_pipeline, epi_load_pipe_consumer_state,</span><br><span class="line">  epi_store_pipeline, epi_store_pipe_producer_state</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="5-4-Store-Pipeline-内部实现"><a href="#5-4-Store-Pipeline-内部实现" class="headerlink" title="5.4 Store Pipeline 内部实现"></a>5.4 Store Pipeline 内部实现</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PipelineTmaStore 使用 TMA scoreboarding 而非 mbarrier</span></span><br><span class="line"><span class="comment">// tma_store_arrive(): 提交一组 TMA store</span></span><br><span class="line"><span class="comment">// tma_store_wait&lt;N&gt;(): 等待直到最多 N 组未完成</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="6-LoadWarpOrderBarrier"><a href="#6-LoadWarpOrderBarrier" class="headerlink" title="6. LoadWarpOrderBarrier"></a>6. LoadWarpOrderBarrier</h2><h3 id="6-1-目的"><a href="#6-1-目的" class="headerlink" title="6.1 目的"></a>6.1 目的</h3><p>确保 <strong>Mainloop Producer 先于 Epilogue Producer 执行</strong>，避免 Epilogue 加载 C 矩阵时 Mainloop 还未开始。</p>
<h3 id="6-2-定义"><a href="#6-2-定义" class="headerlink" title="6.2 定义"></a>6.2 定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:140</span></span><br><span class="line"><span class="keyword">using</span> LoadWarpOrderBarrier = cutlass::OrderedSequenceBarrier&lt;<span class="number">1</span>, <span class="number">2</span>&gt;;</span><br><span class="line"><span class="comment">// SequenceDepth = 1: 只有 1 个 stage</span></span><br><span class="line"><span class="comment">// SequenceLength = 2: 2 个参与者（Mainloop 和 Epilogue）</span></span><br></pre></td></tr></table></figure>

<h3 id="6-3-初始化"><a href="#6-3-初始化" class="headerlink" title="6.3 初始化"></a>6.3 初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:483-486</span></span><br><span class="line"><span class="keyword">typename</span> LoadWarpOrderBarrier::Params params_load_order_barrier;</span><br><span class="line">params_load_order_barrier.group_id = producer_warp_role == ProducerWarpRole::Mainloop ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">params_load_order_barrier.group_size = NumThreadsPerWarp;  <span class="comment">// 32</span></span><br><span class="line"></span><br><span class="line"><span class="function">LoadWarpOrderBarrier <span class="title">load_order_barrier</span><span class="params">(shared_storage.pipelines.load_order,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        params_load_order_barrier)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-使用"><a href="#6-4-使用" class="headerlink" title="6.4 使用"></a>6.4 使用</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mainloop Producer: 完成第一次加载后 arrive</span></span><br><span class="line"><span class="keyword">if</span> (do_load_order_arrive) &#123;</span><br><span class="line">  load_order_barrier.<span class="built_in">arrive</span>();</span><br><span class="line">  do_load_order_arrive = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Epilogue Producer: 等待 Mainloop 先开始</span></span><br><span class="line"><span class="keyword">if</span> (work_tile_info.<span class="built_in">is_valid</span>()) &#123;</span><br><span class="line">  load_order_barrier.<span class="built_in">wait</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-工作原理"><a href="#6-5-工作原理" class="headerlink" title="6.5 工作原理"></a>6.5 工作原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant ML as Mainloop (group_id=0)</span><br><span class="line">    participant OSB as OrderedSequenceBarrier</span><br><span class="line">    participant EL as Epilogue (group_id=1)</span><br><span class="line"></span><br><span class="line">    ML-&gt;&gt;ML: 开始加载 A/B</span><br><span class="line">    ML-&gt;&gt;OSB: arrive() → signal group_id=1</span><br><span class="line"></span><br><span class="line">    EL-&gt;&gt;OSB: wait() → 等待 group_id=0 的 arrive</span><br><span class="line">    Note over EL: wait 解除</span><br><span class="line">    EL-&gt;&gt;EL: 开始加载 C</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="7-TileScheduler-Pipeline"><a href="#7-TileScheduler-Pipeline" class="headerlink" title="7. TileScheduler Pipeline"></a>7. TileScheduler Pipeline</h2><h3 id="7-1-Dynamic-Persistent-Scheduler"><a href="#7-1-Dynamic-Persistent-Scheduler" class="headerlink" title="7.1 Dynamic Persistent Scheduler"></a>7.1 Dynamic Persistent Scheduler</h3><p>当使用 Dynamic Persistent 调度时，需要额外的 pipeline 来协调：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:402-436</span></span><br><span class="line"><span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(IsSchedDynamicPersistent)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Scheduler Pipeline: 用于 CLC 查询结果</span></span><br><span class="line">  scheduler_pipeline_params.producer_blockid = <span class="number">0</span>;</span><br><span class="line">  scheduler_pipeline_params.producer_arv_count = <span class="number">1</span>;</span><br><span class="line">  scheduler_pipeline_params.consumer_arv_count = NumSchedThreads + NumMainloopLoadThreads + NumMMAThreads;</span><br><span class="line">  scheduler_pipeline_params.transaction_bytes = <span class="built_in">sizeof</span>(<span class="keyword">typename</span> TileScheduler::CLCResponse);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Throttle Pipeline: 控制 CLC 查询频率</span></span><br><span class="line">  scheduler_throttle_pipeline_params.producer_arv_count = NumMainloopLoadThreads;</span><br><span class="line">  scheduler_throttle_pipeline_params.consumer_arv_count = NumSchedThreads;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-2-Scheduler-Warp（Warp-1）"><a href="#7-2-Scheduler-Warp（Warp-1）" class="headerlink" title="7.2 Scheduler Warp（Warp 1）"></a>7.2 Scheduler Warp（Warp 1）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:548-580</span></span><br><span class="line"><span class="keyword">if</span> (producer_warp_role == ProducerWarpRole::Warp1) &#123;</span><br><span class="line">  <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(IsSchedDynamicPersistent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (work_tile_info.<span class="built_in">is_valid</span>()) &#123;</span><br><span class="line">      <span class="comment">// Throttle: 等待 Mainloop 准备好</span></span><br><span class="line">      scheduler_throttle_pipeline.<span class="built_in">consumer_wait</span>(scheduler_pipe_throttle_consumer_state);</span><br><span class="line">      scheduler_throttle_pipeline.<span class="built_in">consumer_release</span>(scheduler_pipe_throttle_consumer_state);</span><br><span class="line">      ++scheduler_pipe_throttle_consumer_state;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Query next work tile</span></span><br><span class="line">      scheduler_pipe_producer_state = scheduler.<span class="built_in">advance_to_next_work</span>(</span><br><span class="line">        scheduler_pipeline, scheduler_pipe_producer_state);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Fetch and distribute</span></span><br><span class="line">      <span class="keyword">auto</span> [next_work_tile_info, increment_pipe] = scheduler.<span class="built_in">fetch_next_work</span>(...);</span><br><span class="line">      work_tile_info = next_work_tile_info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    scheduler_pipeline.<span class="built_in">producer_tail</span>(scheduler_pipe_producer_state);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="8-无-cluster-sync-的初始化"><a href="#8-无-cluster-sync-的初始化" class="headerlink" title="8. 无 cluster_sync 的初始化"></a>8. 无 cluster_sync 的初始化</h2><h3 id="8-1-传统方式-vs-Cooperative"><a href="#8-1-传统方式-vs-Cooperative" class="headerlink" title="8.1 传统方式 vs Cooperative"></a>8.1 传统方式 vs Cooperative</h3><table>
<thead>
<tr>
<th>方式</th>
<th>初始化后同步</th>
<th>问题</th>
</tr>
</thead>
<tbody><tr>
<td>传统</td>
<td><code>cluster_sync()</code></td>
<td>所有 CTA 同步，开销大</td>
</tr>
<tr>
<td>Cooperative</td>
<td><code>cluster_arrive_relaxed</code> + 延迟 <code>cluster_wait</code></td>
<td>更灵活</td>
</tr>
</tbody></table>
<h3 id="8-2-实现"><a href="#8-2-实现" class="headerlink" title="8.2 实现"></a>8.2 实现</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码: sm90_gemm_tma_warpspecialized_cooperative.hpp:500-511</span></span><br><span class="line"><span class="keyword">auto</span> cluster_wait_fn = [] () &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">constexpr</span> (<span class="built_in">size</span>(ClusterShape&#123;&#125;) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    cute::<span class="built_in">cluster_arrive_relaxed</span>();  <span class="comment">// 非阻塞 arrive</span></span><br><span class="line">    <span class="keyword">return</span> [] () &#123; cute::<span class="built_in">cluster_wait</span>(); &#125;;  <span class="comment">// 返回延迟执行的 wait</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    __syncthreads();</span><br><span class="line">    <span class="keyword">return</span> [] () &#123;&#125;;  <span class="comment">// 单 CTA 无需 cluster 同步</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125; ();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... pipeline 初始化 ...</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cluster_wait_fn</span>();  <span class="comment">// 延迟执行 cluster_wait</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-为什么这样设计"><a href="#8-3-为什么这样设计" class="headerlink" title="8.3 为什么这样设计"></a>8.3 为什么这样设计</h3><ol>
<li><strong>减少同步开销</strong>：<code>cluster_arrive_relaxed</code> 不等待其他 CTA</li>
<li><strong>Pipeline 初始化可见性</strong>：延迟的 <code>cluster_wait</code> 确保所有 CTA 看到初始化完成</li>
<li><strong>灵活性</strong>：单 CTA 情况下直接使用 <code>__syncthreads()</code></li>
</ol>
<hr>
<h2 id="9-Pipeline-初始化为-Empty"><a href="#9-Pipeline-初始化为-Empty" class="headerlink" title="9. Pipeline 初始化为 Empty"></a>9. Pipeline 初始化为 Empty</h2><h3 id="9-1-Producer-Consumer-Start-State"><a href="#9-1-Producer-Consumer-Start-State" class="headerlink" title="9.1 Producer&#x2F;Consumer Start State"></a>9.1 Producer&#x2F;Consumer Start State</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Producer 从 phase=1 开始，Consumer 从 phase=0 开始</span></span><br><span class="line">PipelineState mainloop_pipe_producer_state = cutlass::<span class="built_in">make_producer_start_state</span>&lt;MainloopPipeline&gt;();</span><br><span class="line"><span class="keyword">typename</span> CollectiveMainloop::PipelineState mainloop_pipe_consumer_state;  <span class="comment">// phase=0</span></span><br></pre></td></tr></table></figure>

<p>初始时 buffer 为空，Producer 可直接 acquire，Consumer 需等待数据就绪。</p>
<blockquote>
<p><strong>Phase 机制详解</strong>：参见 <a href="/2024/12/23/pipeline-barrier-ptx-mapping/#2-PipelineState-%E8%AF%A6%E8%A7%A3">Pipeline 与 mbarrier - PipelineState</a></p>
</blockquote>
<hr>
<h2 id="10-完整-Pipeline-交互图"><a href="#10-完整-Pipeline-交互图" class="headerlink" title="10. 完整 Pipeline 交互图"></a>10. 完整 Pipeline 交互图</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    subgraph Producer_WG[&quot;Producer WarpGroup&quot;]</span><br><span class="line">        MW[Mainloop Warp&lt;br/&gt;TMA A/B]</span><br><span class="line">        SW[Scheduler Warp&lt;br/&gt;CLC Query]</span><br><span class="line">        EW[Epilogue Warp&lt;br/&gt;TMA C]</span><br><span class="line">        AW[Aux Warp]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph Consumer_WGs[&quot;Consumer WarpGroups&quot;]</span><br><span class="line">        C0[Consumer0&lt;br/&gt;MMA + Epilogue]</span><br><span class="line">        C1[Consumer1&lt;br/&gt;MMA + Epilogue]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph Pipelines[&quot;Pipelines&quot;]</span><br><span class="line">        MLP[Mainloop Pipeline&lt;br/&gt;A/B Sync]</span><br><span class="line">        ELP[Epilogue Load Pipeline&lt;br/&gt;C Sync]</span><br><span class="line">        ESP[Epilogue Store Pipeline&lt;br/&gt;D Sync]</span><br><span class="line">        OSB[LoadWarpOrderBarrier&lt;br/&gt;顺序控制]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    MW --&gt;|produce| MLP</span><br><span class="line">    MLP --&gt;|consume| C0</span><br><span class="line">    MLP --&gt;|consume| C1</span><br><span class="line"></span><br><span class="line">    EW --&gt;|produce| ELP</span><br><span class="line">    ELP --&gt;|consume| C0</span><br><span class="line">    ELP --&gt;|consume| C1</span><br><span class="line"></span><br><span class="line">    C0 --&gt;|produce| ESP</span><br><span class="line">    C1 --&gt;|produce| ESP</span><br><span class="line"></span><br><span class="line">    MW --&gt;|arrive| OSB</span><br><span class="line">    OSB --&gt;|wait| EW</span><br><span class="line"></span><br><span class="line">    style MW fill:#e3f2fd</span><br><span class="line">    style EW fill:#fff3e0</span><br><span class="line">    style C0 fill:#c8e6c9</span><br><span class="line">    style C1 fill:#c8e6c9</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="11-关键要点总结"><a href="#11-关键要点总结" class="headerlink" title="11. 关键要点总结"></a>11. 关键要点总结</h2><ol>
<li><strong>Warp Specialization</strong>：Producer WarpGroup 分为 4 个专用角色</li>
<li><strong>Mainloop Pipeline</strong>：<code>PipelineTmaAsync</code>，使用 mbarrier 同步</li>
<li><strong>Epilogue Store Pipeline</strong>：使用 TMA scoreboarding，无 mbarrier</li>
<li><strong>LoadWarpOrderBarrier</strong>：确保 Mainloop 先于 Epilogue 开始</li>
<li><strong>无阻塞初始化</strong>：<code>cluster_arrive_relaxed</code> + 延迟 <code>cluster_wait</code></li>
</ol>
<h2 id="12-相关文档"><a href="#12-相关文档" class="headerlink" title="12. 相关文档"></a>12. 相关文档</h2><ul>
<li><a href="/2024/12/23/pipeline-barrier-ptx-mapping/">Pipeline 与 mbarrier 深度解析</a> - mbarrier 原理、PipelineState、PTX 指令</li>
<li><a href="/2024/12/24/tma-descriptor-deep-dive/">TMA Descriptor 深度解析</a> - TMA 指令、expect_tx&#x2F;complete_tx</li>
<li><a href="/2024/12/24/tma-multicast-deep-dive/">TMA Multicast 深度解析</a> - Cluster 内数据广播</li>
</ul>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/cutlass">CUTLASS GitHub 仓库</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/cutlass/blob/main/include/cutlass/gemm/kernel/sm90_gemm_tma_warpspecialized_cooperative.hpp">sm90_gemm_tma_warpspecialized_cooperative.hpp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/cutlass/blob/main/include/cutlass/gemm/collective/sm90_mma_tma_gmma_ss_warpspecialized.hpp">sm90_mma_tma_gmma_ss_warpspecialized.hpp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/cutlass/blob/main/include/cutlass/epilogue/collective/sm90_epilogue_tma_warpspecialized.hpp">sm90_epilogue_tma_warpspecialized.hpp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/cutlass/blob/main/include/cutlass/pipeline/sm90_pipeline.hpp">sm90_pipeline.hpp</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>0x09 CUTLASS SM90 Cooperative Kernel Pipeline</p><p><a href="https://drxuqian.github.io/2024/12/24/0x09-cooperative-kernel-pipeline/">https://drxuqian.github.io/2024/12/24/0x09-cooperative-kernel-pipeline/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>DrXuQian</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-12-24</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-12-25</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/CUTLASS/">CUTLASS</a><a class="link-muted mr-2" rel="tag" href="/tags/SM90/">SM90</a><a class="link-muted mr-2" rel="tag" href="/tags/Pipeline/">Pipeline</a><a class="link-muted mr-2" rel="tag" href="/tags/mbarrier/">mbarrier</a><a class="link-muted mr-2" rel="tag" href="/tags/Warp-Specialization/">Warp Specialization</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/12/24/0x03-ablayout-vs-alayout/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">0x03 ABLayout vs ALayout_64x16 - SS and RS Mode TV Layout</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/12/24/0x0C-tma-descriptor/"><span class="level-item">0x0C CUTLASS SM90 TMA Descriptor Deep Dive</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="DrXuQian"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">DrXuQian</p><p class="is-size-6 is-block">CUDA/GPU Enthusiast</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">16</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">35</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/DrXuQian" target="_blank" rel="me noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="GitHub" href="https://github.com/DrXuQian"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CUDA/"><span class="level-start"><span class="level-item">CUDA</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/CUDA/CuTe/"><span class="level-start"><span class="level-item">CuTe</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/CUDA/CuTe/CUTLASS/"><span class="level-start"><span class="level-item">CUTLASS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/CUDA/PTX/"><span class="level-start"><span class="level-item">PTX</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/CUDA/PTX/Hopper/"><span class="level-start"><span class="level-item">Hopper</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/CUTLASS/"><span class="level-start"><span class="level-item">CUTLASS</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/GPU-Computing/"><span class="level-start"><span class="level-item">GPU Computing</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-24T08:00:00.000Z">2024-12-24</time></p><p class="title"><a href="/2024/12/24/0x0A-gemm-loop-hierarchy/">0x0A CUTLASS SM90 GEMM Loop Hierarchy</a></p><p class="categories"><a href="/categories/GPU-Computing/">GPU Computing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-24T04:00:00.000Z">2024-12-24</time></p><p class="title"><a href="/2024/12/24/0x08-tensor-engine-types/">0x08 CuTe Tensor Engine Types</a></p><p class="categories"><a href="/categories/GPU-Computing/">GPU Computing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-24T03:30:00.000Z">2024-12-24</time></p><p class="title"><a href="/2024/12/24/0x07-ss-op-selector/">0x07 CUTLASS ss_op_selector MMA Atom Selection</a></p><p class="categories"><a href="/categories/GPU-Computing/">GPU Computing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-24T03:00:00.000Z">2024-12-24</time></p><p class="title"><a href="/2024/12/24/0x06-mma-unpack/">0x06 CUTLASS mma_unpack Deep Dive</a></p><p class="categories"><a href="/categories/GPU-Computing/">GPU Computing</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-24T02:30:00.000Z">2024-12-24</time></p><p class="title"><a href="/2024/12/24/0x05-make-tiled-mma/">0x05 CUTLASS make_tiled_mma and MMA_Atom</a></p><p class="categories"><a href="/categories/GPU-Computing/">GPU Computing</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">十二月 2024</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CUTLASS/"><span class="tag">CUTLASS</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SM90/"><span class="tag">SM90</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CuTe/"><span class="tag">CuTe</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GMMA/"><span class="tag">GMMA</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pipeline/"><span class="tag">Pipeline</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/layout/"><span class="tag">layout</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TiledMMA/"><span class="tag">TiledMMA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mbarrier/"><span class="tag">mbarrier</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PTX/"><span class="tag">PTX</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TMA/"><span class="tag">TMA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/thread/"><span class="tag">thread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/value/"><span class="tag">value</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mma/"><span class="tag">mma</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elect/"><span class="tag">elect</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/warp/"><span class="tag">warp</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/synchronization/"><span class="tag">synchronization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/leader/"><span class="tag">leader</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wgmma/"><span class="tag">wgmma</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ss-mode/"><span class="tag">ss-mode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rs-mode/"><span class="tag">rs-mode</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="CUTLASS 学习笔记" height="28"></a><p class="is-size-7"><span>&copy; 2025 DrXuQian</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p><p class="is-size-7">© 2024 DrXuQian</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/DrXuQian"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script><script src="/js/theme-toggle.js"></script></body></html>